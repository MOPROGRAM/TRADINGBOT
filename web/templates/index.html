<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Bot Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body class="bg-gray-900 text-white font-sans" x-data="botDashboard()" x-init="init()">
    <div class="container mx-auto p-4">
        
        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Left Column: Data Panels -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Status & Price Card -->
                <div class="bg-gray-800 p-4 rounded-lg shadow">
                    <h2 class="text-2xl font-bold mb-2" x-text="symbol"></h2>
                    <p class="text-4xl font-mono mb-2" x-text="currentPrice"></p>
                    <div class="flex items-center space-x-2">
                        <span class="text-2xl" x-html="statusIcon"></span>
                        <span class="text-lg" x-text="statusText"></span>
                    </div>
                    <div class="text-xs text-gray-400 mt-2">
                        AI Model Trained: <span x-text="ai_model_last_trained" class="font-mono"></span>
                    </div>
                </div>

                <!-- Status Messages Card -->
                <div class="bg-gray-800 p-4 rounded-lg shadow" x-show="statusMessages.length > 0">
                    <h2 class="text-xl font-semibold mb-2">System Messages</h2>
                    <div class="space-y-2">
                        <template x-for="(msg, index) in statusMessages" :key="index">
                            <div class="p-2 bg-blue-900/50 rounded-lg text-sm" x-html="msg"></div>
                        </template>
                    </div>
                </div>

                <!-- Account Balance Card -->
                <div class="bg-gray-800 p-4 rounded-lg shadow">
                    <h2 class="text-xl font-semibold mb-2">Account Balance</h2>
                    <div class="space-y-2" x-show="Object.keys(balance).length > 0">
                        <template x-for="asset in Object.keys(balance)" :key="asset">
                            <div class="flex justify-between items-center">
                                <span class="font-bold" x-text="asset"></span>
                                <span class="font-mono" x-text="balance[asset] && balance[asset].total ? parseFloat(balance[asset].total).toFixed(4) : 'N/A'"></span>
                            </div>
                        </template>
                    </div>
                     <p x-show="Object.keys(balance).length === 0">Loading balance...</p>
                </div>

                <!-- Position Card -->
                <div class="bg-gray-800 p-4 rounded-lg shadow" x-show="hasPosition">
                    <h2 class="text-xl font-semibold mb-2">Open Position</h2>
                    <div class="space-y-1">
                        <p><strong>Entry Price:</strong> <span x-text="position.entry_price"></span></p>
                        <p><strong>Size:</strong> <span x-text="position.size"></span></p>
                        <p><strong>PnL:</strong> <span x-text="pnl" :class="parseFloat(pnl) >= 0 ? 'text-green-400' : 'text-red-400'"></span></p>
                        <p class="text-xs text-gray-400"><strong>Timestamp:</strong> <span x-text="position.timestamp"></span></p>
                    </div>
                </div>

                <!-- Signal Analysis Card -->
                <div class="bg-gray-800 p-4 rounded-lg shadow">
                    <h2 class="text-xl font-semibold mb-2">Live Signal & Candles</h2>
                    <div class="flex items-center space-x-2 mb-1">
                        <span class="text-2xl" x-text="signal.includes('Buy') ? 'ðŸŸ¢' : (signal.includes('Sell') ? 'ðŸ”´' : 'ðŸŸ¡')"></span>
                        <span class="text-lg" x-text="signal"></span>
                    </div>
                    <p class="text-xs text-gray-400 mb-2" x-text="signalReason"></p>
                    
                    <!-- New Analysis Details Block -->
                    <div class="bg-gray-900/50 p-2 rounded-md mb-3">
                        <h3 class="text-sm font-semibold text-gray-300 mb-1">Signal Analysis Breakdown:</h3>
                        <div class="flex flex-wrap gap-2 mt-2">
                            <template x-for="detail in (analysisDetails || '').split(' | ')" :key="detail">
                                <div class="signal-box" :class="{
                                    'border-green-500 bg-green-900/30': detail.includes('âœ…'),
                                    'border-red-500 bg-red-900/30': detail.includes('âŒ')
                                }">
                                    <span x-text="detail.split(':')[0]"></span>
                                    <span class="font-bold" x-text="detail.split(':')[1]"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <h3 class="text-md font-semibold mb-1">Candles Used for Calculation:</h3>
                    <div class="max-h-48 overflow-y-auto text-xs font-mono">
                        <table class="w-full text-left">
                            <thead class="sticky top-0 bg-gray-700 text-gray-300">
                                <tr>
                                    <th class="px-2 py-1">Time</th>
                                    <th class="px-2 py-1">O</th>
                                    <th class="px-2 py-1">H</th>
                                    <th class="px-2 py-1">L</th>
                                    <th class="px-2 py-1">C</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="(candle, index) in live_candles" :key="index">
                                    <tr class="border-b border-gray-700/50">
                                        <td class="px-2 py-1" x-text="new Date(candle[0]).toLocaleTimeString()"></td>
                                        <td class="px-2 py-1" x-text="candle[1]"></td>
                                        <td class="px-2 py-1" x-text="candle[2]"></td>
                                        <td class="px-2 py-1" x-text="candle[3]"></td>
                                        <td class="px-2 py-1" x-text="candle[4]"></td>
                                    </tr>
                                </template>
                                <tr x-show="live_candles.length === 0">
                                    <td colspan="5" class="text-center py-2">Candle data not available yet.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Trade History Card -->
                <div class="bg-gray-800 p-4 rounded-lg shadow">
                    <h2 class="text-xl font-semibold mb-2">Trade History</h2>
                    <div class="flex justify-between items-center mb-2">
                        <span>Total PnL:</span>
                        <span x-text="totalPnl" class="font-bold" :class="parseFloat(totalPnl) >= 0 ? 'text-green-400' : 'text-red-400'"></span>
                    </div>
                    <div class="max-h-96 overflow-y-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-gray-400 uppercase bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-2 py-2">Time</th>
                                    <th scope="col" class="px-2 py-2">Entry Price</th>
                                    <th scope="col" class="px-2 py-2">Exit Price</th>
                                    <th scope="col" class="px-2 py-2">Size</th>
                                    <th scope="col" class="px-2 py-2">PnL %</th>
                                    <th scope="col" class="px-2 py-2">Status</th>
                                    <th scope="col" class="px-2 py-2">Reason</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="trade in tradeHistory" :key="trade.timestamp">
                                    <tr class="border-b border-gray-700">
                                        <td class="px-2 py-2 text-xs" x-text="new Date(trade.timestamp).toLocaleString()"></td>
                                        <td class="px-2 py-2 font-mono" x-text="parseFloat(trade.entry_price).toFixed(4)"></td>
                                        <td class="px-2 py-2 font-mono" x-text="trade.exit_price ? parseFloat(trade.exit_price).toFixed(4) : 'N/A'"></td>
                                        <td class="px-2 py-2 font-mono" x-text="parseFloat(trade.size).toFixed(6)"></td>
                                        <td class="px-2 py-2" :class="trade.pnl_percent >= 0 ? 'text-green-400' : 'text-red-400'" x-text="trade.pnl_percent ? trade.pnl_percent.toFixed(2) + '%' : 'N/A'"></td>
                                        <td class="px-2 py-2">
                                            <span x-text="trade.is_open ? 'Open' : 'Closed'" :class="trade.is_open ? 'text-yellow-400' : 'text-gray-400'"></span>
                                        </td>
                                        <td class="px-2 py-2" x-text="trade.reason || 'N/A'"></td>
                                    </tr>
                                </template>
                                <tr x-show="tradeHistory.length === 0">
                                    <td colspan="7" class="text-center py-4">No trades yet.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right Column: Chart -->
            <div class="lg:col-span-2 bg-gray-800 p-4 rounded-lg shadow min-h-[600px]">
                <div class="tradingview-widget-container" style="height:100%;width:100%">
                  <div id="tradingview_chart" style="height:100%;width:100%"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script>
        function botDashboard() {
            return {
                symbol: '{{ symbol }}',
                currentPrice: 'Loading...',
                hasPosition: false,
                position: {},
                pnl: '0.00%',
                statusIcon: 'ðŸŸ¡',
                statusText: 'Initializing...',
                balance: {},
                tradeHistory: [],
                totalPnl: '0.00%',
                signal: 'Initializing...',
                signalReason: 'Waiting for data...',
                analysisDetails: 'Waiting for data...',
                strategy_params: {},
                live_candles: [],
                statusMessages: [],
                lastModified: null,
                ai_model_last_trained: 'N/A',
                init() {
                    this.loadDashboardData(); // Load data via REST API
                    this.loadTradingViewChart();
                    // Refresh data periodically
                    setInterval(() => this.loadDashboardData(), 10000); // Every 10 seconds
                },

                async loadDashboardData() {
                    try {
                        const response = await fetch('/api/status');
                        const data = await response.json();
                        this.updateDashboard(data);
                    } catch (error) {
                        console.error('Error fetching dashboard data:', error);
                        this.statusIcon = 'ðŸ”´';
                        this.statusText = 'API Error';
                    }
                },

                updateDashboard(data) {
                    if (data.error) {
                        console.error('Error from API data:', data.error);
                        this.statusIcon = 'ðŸ”´';
                        this.statusText = 'API Error';
                        return;
                    }

                    this.currentPrice = data.current_price ? '$' + parseFloat(data.current_price).toFixed(4) : 'N/A';
                    this.hasPosition = data.has_position;
                    this.balance = data.balance || {};
                    this.tradeHistory = data.trade_history || [];
                    this.totalPnl = data.total_pnl ? data.total_pnl.toFixed(2) + '%' : '0.00%';
                    this.signal = data.signal || 'Waiting...';
                    this.signalReason = data.signal_reason || 'N/A';
                    this.analysisDetails = data.analysis_details || 'N/A';
                    this.strategy_params = data.strategy_params || {};
                    this.live_candles = data.live_candles || [];
                    this.statusMessages = data.status_messages || [];
                    this.ai_model_last_trained = data.ai_model_last_trained || 'N/A';

                    // Check if the state has been significantly changed by the bot
                    if (this.lastModified && this.lastModified !== data.last_modified) {
                        // A sell or a buy just happened. Clear messages after a delay.
                        setTimeout(() => { this.statusMessages = [] }, 5000);
                    }
                    this.lastModified = data.last_modified;

                    if (this.hasPosition) {
                        this.position = {
                            entry_price: data.position.entry_price ? parseFloat(data.position.entry_price).toFixed(4) : 'N/A',
                            size: data.position.size ? parseFloat(data.position.size).toFixed(6) : 'N/A',
                            timestamp: data.position.timestamp ? new Date(data.position.timestamp).toLocaleString() : 'N/A',
                        };
                        this.pnl = data.pnl.toFixed(2) + '%';
                        this.statusIcon = 'ðŸŸ¢';
                        this.statusText = 'Position Open';
                    } else {
                        this.position = {};
                        this.pnl = '0.00%';
                        this.statusIcon = 'ðŸŸ¡';
                        this.statusText = 'Waiting for Signal';
                    }
                },

                loadTradingViewChart() {
                    new TradingView.widget({
                        "autosize": true,
                        "symbol": `BINANCE:{{ symbol.replace('/', '') }}`,
                        "interval": "5",
                        "timezone": "Etc/UTC",
                        "theme": "dark",
                        "style": "1",
                        "locale": "en",
                        "enable_publishing": false,
                        "hide_side_toolbar": false,
                        "allow_symbol_change": true,
                        "container_id": "tradingview_chart"
                    });
                }
            }
        }
    </script>
</body>
</html>
